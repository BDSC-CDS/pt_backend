apiVersion: v1
kind: Secret
metadata:
  name: arx-psql-secret
  namespace: {{ .Release.Namespace }}{{- if .Values.namespace }}{ .Values.namespace }{{- end }}
  labels:
    {{- include "pt-arx-service-chart.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: Opaque
data:
  # Lookup for an existing secret and get existing data
  {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace "psql-secret") | default dict }}
  {{- $secretData := (get $secretObj "data") | default dict }}

  # Get user specified values
  {{- $userPostgresPassword := .Values.postgresql.secrets.postgresPassword | default "" }}
  
  # Define the postgres password based on priority: user values â†’ existing secret
  {{- $postgresPassword := (.Values.postgresql.secrets.postgresPassword | default (get $secretData "postgres-password" | default "" | b64dec)) | b64enc }}

  postgres-password: {{ $postgresPassword }}
